{% extends 'base.html' %}
{% block content %}

{% if 'logged_in_user' in session %}
<!--   <h2>User Profile</h2> -->
<div class="tripsTable">
  <ul class="nav nav-tabs">
    <li class="active buttonText showTripsButton" id="viewTrips"><a data-toggle="tab" href="#yourTrips">Your Trips</a></li>
    <li class="buttonText showTripsButton" id="viewShared"><a data-toggle="tab" href="#sharedTrips">Friends Trips</a></li>
  </ul>
  <div class="showTrips" id="yourTrips">
  {% if not trips %}
    <p>You dont have any trips yet!</p>
    {% else %}
        {% for trip in trips %}
          <div class="myTrip tripItem">
          <p class="trip-link"><a href="/trip/{{ trip.trip_id }}" class="trip-name">{{ trip.name }}</a></p>
          <p class="trip-location">{{ trip.location }}</p>
          <p class="trip-date">{{ trip.date }}</p>
          </div>
        {% endfor %}
    {% endif %}
  </div>
  <div class="showTrips" id="sharedTrips" hidden>
  {% if not friends_trips %}
    <p>No friends trips to see!</p>
    {% else %}
        {% for trip in friends_trips %}
          <div class="theirTrip tripItem">
          <p class="trip-link">{% if trip.trip_id in shared_trips %}<a href="/trip/{{ trip.trip_id }}" class="trip-name">{{ trip.name }}</a>{% else %}<span class="trip-name">{{ trip.name }}</span>{% endif %}</p>
          <p class="trip-location">{{ trip.location }}</p>
          <p class="trip-owner">Owner: {{ trip.user.email }}</p>
          {% if trip.trip_id not in shared_trips %}
          <button class="requestDetails" name="{{ trip.trip_id }}">Request Details</button>
          {% endif %}
          </div>
        {% endfor %}
      {% endif %}
  </div>
    <button class="addNewButton" id="addTrip">Add New Trip</button>
    <button class="addNewButton" id="requestFriend">Request Friend</button>
</div>
  <div id="trip-map"></div>
      <!-- Show modals -->
  <div id="trip-form-popup" class="modal">
    <div class="form-content">
      <span class="close">&times;</span>
      <h2>New Trip</h2>
      <form id="trip_form" action="/add-trip" method="POST">Name: 
        <input type="text" id="name" name="name"><br>Location: 
        <input id="autocomplete" name="location" placeholder="Where are you going?" type="text"><br>Date:
        <input type="date" id="date" name="date"><br>
        <input type="submit" id="submit_button">
      </form>
      </div>
    </div>
    <!-- Show modals -->
  <div id="friend-form-popup" class="modal">
    <div class="form-content">
      <span class="close">&times;</span>
      <h2>Request Friend</h2>
        <form id="request_form" method="POST">Who would you like to become friends with?<br>
          <input id="friendEmail" placeholder="Email Address" type="text" name="requestEmail">
          <input type="submit" id="request_submit_button">
        </form>
        <form id="invite_friend_form" action="/invite-user" method="POST" hidden>This user does not exist would you like to invite them to join SOJOURNAL?<br>
              <input id="inviteFriendEmail" placeholder="Email Address" type="text" name="inviteEmail">
              <input type="submit" id="invite_friend_submit_button">
        </form>
      </div>
    </div>
        <script>

      var map;
      var visibleMarkers = [];

      function initMap() {
        geocoder = new google.maps.Geocoder();
        loc = new google.maps.LatLng("30","5");
        var mapOptions = 
        {
          zoom: 2,
          center: loc
        }
        map = new google.maps.Map(document.getElementById('trip-map'), mapOptions);
        addMarkers('.myTrip');
      } 

      function initAutocomplete() {
        // Create the autocomplete object, restricting the search to geographical
        // location types.
        autocomplete = new google.maps.places.Autocomplete(
            /** @type {!HTMLInputElement} */(document.getElementById('autocomplete')),
            {types: ['(regions)']});
      }

      function codeMarkerAddress(address, name, contentString) {
        // console.log(address);
        geocoder.geocode( {address:address}, function(results, status) {
          if (status == google.maps.GeocoderStatus.OK) {
            // console.log(results);
            // place a marker at the location
            var marker = new google.maps.Marker({
                map: map,
                position: results[0].geometry.location,
                animation: google.maps.Animation.DROP,
                title: name
            });
            // console.log(results[0].geometry.location);
            visibleMarkers.push(marker);
            var infowindow = new google.maps.InfoWindow({
            content: contentString
            });
            marker.addListener('click', function() {
            infowindow.open(map, marker);
        });
          } else {
            alert('Geocode was not successful for the following reason: ' + status);
         }
        });
      }


      function addMarkers(className) {
        $( className ).each(function() {
        var location = $(this).children(".trip-location").html();
        var name = $(this).children(".trip-link").children(".trip-name").html();
        // var date = $(this).children(".trip-date").html();
        var link = $(this).children(".trip-link").children(".trip-name").attr("href");
        var contentString = '<div id="content">'+
            '<h1><a href=\"'+link+'\">'+name+'</a></h1>'+
            '<div id="bodyContent">'+
            '<p>'+location+'</p>'+
            '</div>'+
            '</div>';
        codeMarkerAddress(location, name, contentString);

      });
      }

      //Add event handler to trip buttons
    $("#viewShared").on('click', function() {
      $("#yourTrips").attr('hidden', true);
      $("#sharedTrips").attr('hidden', false);
      visibleMarkers.forEach(function(marker) {
        marker.setMap(null);
      });
      addMarkers('.theirTrip');
    });

    $("#viewTrips").on('click', function() {
      $("#yourTrips").attr('hidden', false);
      $("#sharedTrips").attr('hidden', true);
      visibleMarkers.forEach(function(marker) {
        marker.setMap(null);
      });
      addMarkers('.myTrip');
    });

      // Get the modal
    var tripModal = document.getElementById('trip-form-popup');

    // Get the button that opens the modal
    var tripBtn = document.getElementById("addTrip");

    // Get the <span> element that closes the modal
    var tripSpan = document.getElementsByClassName("close")[3];

    // When the user clicks on the button, open the modal 
    tripBtn.onclick = function() {
        tripModal.style.display = "block";
    }

    // When the user clicks on <span> (x), close the modal
    tripSpan.onclick = function() {
        tripModal.style.display = "none";
    }

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
        if (event.target == tripModal) {
            tripModal.style.display = "none";
      }
    }

          // Get the modal
    var friendModal = document.getElementById('friend-form-popup');

    // Get the button that opens the modal
    var friendBtn = document.getElementById("requestFriend");

    // Get the <span> element that closes the modal
    var friendSpan = document.getElementsByClassName("close")[3];

    // When the user clicks on the button, open the modal 
    friendBtn.onclick = function() {
        friendModal.style.display = "block";
    }

    // When the user clicks on <span> (x), close the modal
    friendSpan.onclick = function() {
        friendModal.style.display = "none";
        $('#request_form').attr('hidden', false);
        $('#invite_friend_form').attr('hidden', true);
    }

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
        if (event.target == friendModal) {
            friendModal.style.display = "none";
            $('#request_form').attr('hidden', false);
            $('#invite_friend_form').attr('hidden', true);
      }
    }

      function flashMessage(message) {
        $('.flash').addClass('alert');
        $('.flash').html(message);
        setTimeout(function() {
          $('.flash').empty();
          $('.flash').removeClass('alert');
        }, 3000);
      }

      //Ajax request to share trip
      function friendRequested(result) {
        var status = result;
        if (status.request_status == "no user") {
          $('#request_form').attr('hidden', true);
          $('#invite_friend_form').attr('hidden', false);
          $('#requestEmail').val($('#inviteFriendEmail').val());
        } else if (status.request_status == "already friends") {
          friendModal.style.display = "none";
          flashMessage("You are already friends with that user!")
        } else {
          friendModal.style.display = "none";
          flashMessage("Friend request sent!")
        }
      }

      //Ajax call
      function requestFriend(evt) {
        evt.preventDefault();
        var formInputs = {
          "email": $('#friendEmail').val()
        };
        $.post("/request-friend.json", formInputs, friendRequested);
      }
    
      //Add event handler to share form
      $('#request_form').on('submit', requestFriend);

    //Ajax request to accept friend
    function shareRequest() {
      $(".requestDetials[name=status]").attr('disabled', true);
    }

    //Ajax call
    function requestDetails() {
      var formInputs = {
        "trip_id": this.getAttribute("name")
      };
      $.post("/share-request.json", formInputs, shareRequest);
    }

  // Add event handler to all friend request accept buttons
  $('.requestDetails').on('click', requestDetails)

    function initialize() {
      initMap();
      initAutocomplete();
    }

    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCH3NV21lKUUJpatY7B06dgXTLQR0oikV4&libraries=places&callback=initialize" async defer></script>
{% else %}
    <h2>This is the homepage</h2>          
{% endif %}

{% endblock %}