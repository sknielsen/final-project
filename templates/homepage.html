{% extends 'base.html' %}
{% block content %}

{% if 'logged_in_user' in session %}
    <h2>User Profile</h2>
    <h3>Trips</h3>
    {% if not trips %}
    <p>You dont have any trips yet!</p>
    {% else %}
      <ul> 
        {% for trip in trips %}
          <li class="trip">
          <p class="trip-link"><a href="/trip/{{ trip.trip_id }}" class="trip-name">{{ trip.name }}</a></p>
          <p class="trip-location">{{ trip.location }}</p>
          <p class="trip-date">{{ trip.date }}</p>
          </li>
        {% endfor %}
      </ul>
    {% endif %}
    <button id="addTrip">Add New Trip</button>
      <!-- Show modals -->
    <div id="trip-form-popup" class="modal">
        <div class="trip-form-content">
          <span class="close">&times;</span>
          <h2>New Trip</h2>
          <form id="trip_form" action="/add-trip" method="POST">Name: 
            <input type="text" id="name" name="name"><br>Location: 
            <input type="text" id="location" name="location"><br>Date:
            <input type="date" id="date" name="date"><br>
            <input type="submit" id="submit_button">
          </form>
          </div>
      </div>
    <div id="trip-map"></div>
        <script>

      function initMap() {
        geocoder = new google.maps.Geocoder();
        loc = new google.maps.LatLng("30","5");
        var mapOptions = 
        {
          zoom: 2,
          center: loc
        }
        map = new google.maps.Map(document.getElementById('trip-map'), mapOptions);
        addMarkers();
      }

      function codeMarkerAddress(address, name, contentString) {
        geocoder.geocode( {address:address}, function(results, status) {
          if (status == google.maps.GeocoderStatus.OK) {
            // place a marker at the location
            var marker = new google.maps.Marker({
                map: map,
                position: results[0].geometry.location,
                title: name
            });
            var infowindow = new google.maps.InfoWindow({
            content: contentString
            });
            marker.addListener('click', function() {
            infowindow.open(map, marker);
        });
          } else {
            alert('Geocode was not successful for the following reason: ' + status);
         }
        });
      }


      function addMarkers() {
        $( ".trip" ).each(function() {
        var location = $(this).children(".trip-location").html();
        var name = $(this).children(".trip-link").children(".trip-name").html();
        var date = $(this).children(".trip-date").html();
        var link = $(this).children(".trip-link").children(".trip-name").attr("href");
        var contentString = '<div id="content">'+
            '<h1><a href=\"'+link+'\">'+name+'</a></h1>'+
            '<div id="bodyContent">'+
            '<p>'+location+'</p>'+
            '<p>'+date+'</p>'+
            '</div>'+
            '</div>';
        codeMarkerAddress(location, name, contentString);
      });
      }


      // Get the modal
    var modal = document.getElementById('trip-form-popup');

    // Get the button that opens the modal
    var btn = document.getElementById("addTrip");

    // Get the <span> element that closes the modal
    var span = document.getElementsByClassName("close")[2];

    // When the user clicks on the button, open the modal 
    btn.onclick = function() {
        modal.style.display = "block";
    }

    // When the user clicks on <span> (x), close the modal
    span.onclick = function() {
        modal.style.display = "none";
    }

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
      }
    }
      

    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCH3NV21lKUUJpatY7B06dgXTLQR0oikV4&callback=initMap">
    </script>
{% else %}
    <h2>This is the homepage</h2>          
{% endif %}

{% endblock %}